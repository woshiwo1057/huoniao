{include file="public/header"} {include file="public/sidebar"}

<link rel="stylesheet" type="text/css" href="__INDEX__css/cropper.min.css">
<script type="text/javascript" src="__INDEX__js/cropper.min.js"></script>

<body>
	<!-- 引入头部 -->
	<div class="main miva-join-page">
		<!-- 陪玩入驻服务 -->
		<div class="miva-join-us">陪玩申请服务项目(<span>*请上传清晰图片</span>)</div>
		<!-- 基本资料 -->
			<style media="screen">
				.miva-input {
					padding: 0 10px;
				}

				.service-act {
					border-radius: 3px;
					background: #FBC94C;
					color: #fff;
					padding: 5px 15px;
					margin: 5px !important;
				}
			</style>
		
		<div class="miva-join-title">开通游戏</div>
		<div class="miva-box miva-game-box layui-form">
			<div class="miva-select layui-form-item">
				<select class="project" lay-filter='item-check' name="project" id="project">
					<option>请选择服务项目</option> 
					<option value="1">游戏项目</option>
					<option value="2">娱乐项目</option>
				</select>
			</div>
			<!-- 二级类目选择 -->
			<div class="miva-selected-box"></div>
		</div>
		<div class="miva-join-title">认证资料照</div>
		<div class="miva-box miva-data-box">
			<label for="duanwei"><img style="border:none;" class="miva-up-data-pic" src="" alt="">
				<div class="up-data-tip"><span>点击上传您的游戏段位(等级)截图,<br>并填写游戏相关说明补充<br>(包含游戏ID)</span></div><br>
				<div class="miva-btn mia-up-btn">点击上传</div>
			</label>
			<input style="display:none" type="file" id="duanwei">

			<span class="miva-li">示例:</span>
			<img style="border:none;" src="__IMG__example.png" alt=""></div>
		<div class="miva-join-title">说明</div>
		<div class="miva-box miva-info-box"><textarea name="explain" class="txt-box" placeholder="可以写自己喜欢的游戏,喜欢的玩法和打法......"></textarea></div>
		<!--<div class="miva-join-title">语音介绍</div><div class="miva-box miva-audio-box"><div class="audio-box-f"><div class="audio-box"><div class="audio-btn"><i class="layui-icon layui-icon-voice"></i><span>点击上传</span></div></div><audio src="" controls></audio></div><span class="tip">上传录音可供游客试听,请自行上传录音 格式为:MP3 大小:2MB<span>支持格式:MP3,ogg,mav,m4a</span></span></div>-->
		<div class="check-box"><!--<input id="check" type="checkbox"> <label for="check">我已阅读并同意<a href="{:url('Conpanion/agreement')}" target="__blnk"><<陪玩申请入驻协议>></a></label>--></div>
		<button style="color:#FFF" class="miva-btn miva-btn-act xiaoshou submit">提交入驻申请</button>
	</div>
	<!-- 引入侧边栏 -->
	<!-- 引入页脚 -->
	{include file="public/footer"}
	<script>
var img_data = '';
var type;
var cityVal = '';
var isSubmitOff = false;

	// 图片预览
	$('input[type=file]').on('change', function() {
		var _this = this;
		var files = $(this);
		var img = $('.miva-up-data-pic');
		var fileBuffer;
		var reader = new FileReader();
		var alertHTML = '<img id="newMiva" src=""/>';
		
		reader.readAsDataURL(files.prop('files')[0]);
		reader.onload = function(e) {
			// 获取file里的内容
			fileBuffer = e.target.result;

			layer.open({
				type: 1,
				title: false,
				closeBtn: 0,
				content: alertHTML,
				scrollbar: false,
				btn: ['确认', '取消'],
				area: ['100%', '100%'],
				success: function(layero, index) {
					var imgbox = layero.find("#newMiva");
					var miva;
					imgbox.attr('src', fileBuffer);

					if (_this.id == 'user-pic')
						miva = 1 / 1;
					else if (_this.id == 'bg-pic')
						miva = 9 / 16;

					imgbox.cropper({
						aspectRatio: miva,
						dragMode: 'move', // 设置为  ‘move’: 只可以移动模式
						dragCrop: false, // 设置为禁止移除当前的剪裁框，并通过拖动来新建一个剪裁框区域。
						toggleDragModeOnDblclick: false, // 禁止双击切换模式
					});

				},
				yes: function(index, layero) {
					var imgbox = layero.find("#newMiva");
					var cas = imgbox.cropper('getCroppedCanvas');
					var base64url = cas.toDataURL('image/jpeg');
					img_data = base64url
					img.attr('src', base64url);
					layer.closeAll();
				},
				btn2: function(index, layero) {
					layer.closeAll();
				}
			});

		};
		// 重置input[type=file];
		files.val('');
	});


		
		layui.use(['form', 'laydate'], function() {
			var form = layui.form;
			var laydate = layui.laydate;
			

			laydate.render({
					elem: '#data-check' //指定元素
				});; // 使用layui日期选择器
			
			form.on('select(item-check)', function(res) {
			type = res.value
				$.post("{:url('Conpanion/project')}", {
					type: res.value
				}, function(res) {
					var str = '';
					for (a of res) {
						str += "<span data-item=mivaservice attr_id=" + a['id'] + ">" + a['name'] + "</span>";
					}

					$('.miva-selected-box').html(str);

						if (isMivaService) {
							$('.miva-selected-box').on('click', '[data-item=mivaservice]', function() { // 选择服务时的激活样式
								$(this).addClass('service-act').siblings().removeClass('service-act');
							// if ($(this).prop('class').indexOf('service-act') == -1) {
							// 	$(this).addClass('service-act');
							// } else {
							// 	$(this).removeClass('service-act');
							// }
							isMivaService = false;
						});
					};

				}, 'json')
			});

			form.on('select(province)', function(result) { // 请选择省份
				$('#city').html('<option value="">请选择城市</option>');

				$.post("{:url('Conpanion/city_ajax')}", {
					province: result.value
				}, function(res) {
					var html = '';
					for (var i = 0; i < res.length; i++) {
						html += '<option value="' + res[i].code + '">' + res[i].name + '</option>';
					};
					$("#city").append(html);
					form.render('select');
				}, 'json') 
			});

			form.on('select(city)', function(res) { // 选择城市
				cityVal = res.value
			})
		})

$('#buwei').on('click', 'span.radio', function() {
	$(this).addClass('active-radio').siblings().removeClass('active-radio')
});
 			var isMivaService = true;
			var num = 1;
			$('#xian').on('click', 'span.miva-btn', function() { // 线上线下

				if ($(this).prop('class').indexOf('miva-btn-act') == -1) {
					$(this).addClass('miva-btn-act');
					$(this).attr('acc_type') == '1' ? num = num + 1 : num = num + 2;
				} else {
					$(this).removeClass('miva-btn-act');
					$(this).attr('acc_type') == '1' ? num = num - 1 : num = num - 2;
				}
			});

/*
$('.check-box').on('change','input', function() {
	isSubmitOff = !isSubmitOff;
	if (isSubmitOff) {
		$('.submit').removeAttr('disabled').addClass('miva-btn-act');
	}else {
		$('.submit').attr('disabled', 'true').removeClass('miva-btn-act');
	}
})
*/

		$('.submit').click(function() { 
								

			var project_id = $('.service-act').attr('attr_id') //游戏ID
			if(!project_id){
				layui.use('layer', function(){
					layer.msg('请选择服务项目')
				}) 
				return false
			}


			if(!img_data){
				layui.use('layer', function() {
					layer.msg('请填上传资料照')
				}) 
				return false
			}

			var explain = $('[name="explain"]').val();
			if (explain == '') {
				layui.use('layer', function() {
					layer.msg('请填写说明')
				}) 
				return false
			}
			

			var acc_type = num //   线上/线下
			
			//type     1：游戏项目  2：娱乐项目
			//img_data  base64




			$.post("{:url('User/service_add')}", {
				
				project:type,
				//img_data:img_data,				
				project_id:project_id,
				explain:explain,
				acc_type:acc_type
			}, function(data){
				if(data.code == 1){
					layui.use('layer', function() {
					layer.msg(data.msg)
					})
				}else if(data.code == 2){
					layui.use('layer', function() {
					layer.msg(data.msg)
					})
				}else if(data.code == 3){
					layui.use('layer', function() {
					layer.msg(data.msg)
					})
				}else if(data.code == 4){
					layui.use('layer', function() {
					layer.msg(data.msg)
					})
				}else{
					layui.use('layer', function() {
					layer.msg('未知错误')
					})
				}
			}, 'json')
			return false
		})
	</script>
</body>

</html>
